<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HPC Cluster GPU Survey</title>
  <style>
    :root{--bg:#f8fafc;--card:#fff;--muted:#6b7280;--primary:#4f46e5;--ring:#c7d2fe}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    body{margin:0;background:linear-gradient(180deg,#f8fafc,#eef2ff)}
    .wrap{max-width:900px;margin:0 auto;padding:28px}
    h1{margin:0 0 8px;font-size:clamp(22px,3vw,30px)}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .section{background:var(--card);padding:18px;border-radius:16px;border:1px solid #e5e7eb;margin:14px 0}
    label{font-size:14px;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;outline:none;background:#fff}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px var(--ring);border-color:#a5b4fc}
    .grid{display:grid;gap:12px}
    @media(min-width:780px){.grid-2{grid-template-columns:1fr 1fr}.row{grid-template-columns:7fr 3fr 2fr}}
    .row{display:grid;gap:12px;align-items:end}
    .btn{border:1px solid transparent;border-radius:14px;padding:10px 16px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;border-color:#e5e7eb;color:#111}
    .btn.link{background:#eef2ff;color:#3730a3;border-color:#c7d2fe}
    .btn.danger{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .toolbar{display:flex;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .msg{padding:10px 12px;border-radius:12px;margin-top:8px;border:1px solid #e5e7eb;display:none}
    .msg.error{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .msg.success{background:#ecfeff;border-color:#a5f3fc;color:#155e75}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>HPC Cluster GPU Survey</h1>
      <p class="lead">Select GPU models and enter quantities on the same line.</p>
    </header>

    <form id="survey-form" class="grid" onsubmit="return false;">
      <section class="section">
        <h2>About you</h2>
        <div class="grid grid-2">
          <div>
            <label for="name">Name</label>
            <input id="name" required />
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" required />
          </div>
          <div class="grid-2" style="grid-column:1/-1">
            <div>
              <label for="org">Institution / Organization</label>
              <input id="org" />
            </div>
            <div>
              <label for="usecase">Primary use case</label>
              <input id="usecase" placeholder="GenAI, CFD, MD, training, inference" />
            </div>
          </div>
        </div>
      </section>

      <section class="section">
        <h2>GPU selections</h2>
        <div id="rows" class="grid" aria-live="polite"></div>
        <div class="toolbar">
          <button type="button" class="btn link" id="add-row">+ Add another GPU</button>
          <div class="muted">Total GPUs selected: <strong id="total">0</strong></div>
        </div>
      </section>

      <section class="section">
        <h2>Notes (optional)</h2>
        <textarea id="notes" rows="4" placeholder="Interconnects, node configs, timelines, vendor preferences, etc."></textarea>
      </section>

      <div id="msg" class="msg"></div>

      <div style="display:flex;gap:10px">
        <button class="btn" id="submit-btn" type="submit">Submit</button>
        <button class="btn secondary" id="reset-btn" type="button">Reset</button>
      </div>
      <p class="muted" style="font-size:12px">By submitting, you consent to storage and processing of your responses for analysis purposes.</p>
    </form>
  </div>

  <script>
    // ==== SET THIS to your public /macros/s/.../exec URL ====
    const FLOW_URL = "https://script.google.com/macros/s/AKfycbw_JPgQbzl0aVRKqAE8UiJh388_iOBvIWMD3oiNcjtl6UJ5Z__o5E82bprIgRrx-nNE/exec";
    // ========================================================

    const GPU_GROUPS = [
      { label: 'NVIDIA Data Center', items: [
        'H200 SXM (141GB)','H100 SXM (80GB)','H100 PCIe (80GB)','A100 SXM (80GB)',
        'A100 PCIe (40GB)','L40S (48GB)','RTX 6000 Ada (48GB)','A40 (48GB)','A30 (24GB)','A10 (24GB)'
      ]},
      { label: 'AMD Data Center', items: [ 'MI300X (192GB)','MI300A (128GB)','MI250 (128GB)' ]},
      { label: 'Other / Edge', items: [ 'Grace Hopper GH200','Consumer RTX 4090 (24GB)','Other (specify in Notes)' ]}
    ];

    const rowsEl = document.getElementById('rows');
    const totalEl = document.getElementById('total');
    const msgEl = document.getElementById('msg');

    function showMsg(kind, text){
      msgEl.className = 'msg ' + (kind === 'error' ? 'error' : 'success');
      msgEl.style.display = 'block';
      msgEl.textContent = text;
    }
    function clearMsg(){ msgEl.style.display = 'none'; msgEl.textContent=''; msgEl.className='msg'; }

    function makeSelect(id){
      const sel = document.createElement('select');
      sel.id = id; sel.required = true;
      const placeholder = document.createElement('option');
      placeholder.value=''; placeholder.textContent='Select a GPU…'; placeholder.selected = true; placeholder.disabled = true;
      sel.appendChild(placeholder);
      GPU_GROUPS.forEach(g=>{
        const og = document.createElement('optgroup'); og.label = g.label;
        g.items.forEach(item=>{ const opt=document.createElement('option'); opt.value=item; opt.textContent=item; og.appendChild(opt); });
        sel.appendChild(og);
      });
      return sel;
    }
    function makeQtyInput(id){
      const inp = document.createElement('input');
      inp.type='number'; inp.min='1'; inp.step='1'; inp.placeholder='1'; inp.id=id;
      inp.addEventListener('input', updateTotal);
      return inp;
    }
    function rowTemplate(index){
      const row = document.createElement('div'); row.className='row'; row.dataset.index=index;
      const gWrap = document.createElement('div'); const gLabel = document.createElement('label'); gLabel.textContent='GPU model'; gLabel.setAttribute('for',`gpu-${index}`); const gSel = makeSelect(`gpu-${index}`); gWrap.appendChild(gLabel); gWrap.appendChild(gSel);
      const qWrap = document.createElement('div'); const qLabel = document.createElement('label'); qLabel.textContent='Quantity'; qLabel.setAttribute('for',`qty-${index}`); const qInp = makeQtyInput(`qty-${index}`); qWrap.appendChild(qLabel); qWrap.appendChild(qInp);
      const bWrap = document.createElement('div'); const btn = document.createElement('button'); btn.type='button'; btn.className='btn danger'; btn.textContent='Remove'; btn.addEventListener('click',()=>{ row.remove(); updateTotal(); }); bWrap.appendChild(btn);
      row.appendChild(gWrap); row.appendChild(qWrap); row.appendChild(bWrap); return row;
    }
    function addRow(){ rowsEl.appendChild(rowTemplate(rowsEl.children.length)); }
    function updateTotal(){
      let sum = 0; [...rowsEl.querySelectorAll(\"input[id^='qty-']\")].forEach(inp=>{ const v = parseInt(inp.value||'0',10); if(Number.isFinite(v)) sum += v; });
      totalEl.textContent = String(sum);
    }
    function getSelections(){
      const out = []; [...rowsEl.children].forEach(row=>{
        const sel=row.querySelector('select'), qty=row.querySelector('input');
        const model=sel.value, q=parseInt(qty.value||'0',10);
        if(model && q>0) out.push({ model, qty:q });
      }); return out;
    }

    // Primary: simple POST (text/plain) — no preflight
    async function postJSON(url, payload){
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      return res.ok;
    }

    // Fallback: GET image beacon with base64 payload to /exec?p=...
    function beaconGET(url, payload){
      return new Promise((resolve) => {
        try {
          const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
          const img = new Image();
          img.onload = () => resolve(true);
          img.onerror = () => resolve(true); // even if opaque, Apps Script still handled it
          img.src = `${url}?p=${encodeURIComponent(b64)}&t=${Date.now()}`;
        } catch (_) {
          resolve(false);
        }
      });
    }

    // Init rows
    document.getElementById('add-row').addEventListener('click', addRow);
    document.getElementById('reset-btn').addEventListener('click', ()=>{ document.getElementById('survey-form').reset(); rowsEl.innerHTML=''; addRow(); updateTotal(); clearMsg(); });
    addRow();

    // Submit
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.addEventListener('click', async ()=>{
      if (submitBtn.disabled) return;
      clearMsg();

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      if(!name){ showMsg('error','Please enter your name.'); return; }
      if(!email){ showMsg('error','Please enter a contact email.'); return; }
      const selections = getSelections();
      if(selections.length===0){ showMsg('error','Select at least one GPU with quantity > 0.'); return; }

      const payload = {
        submittedAt: new Date().toISOString(),
        respondent: {
          name, email,
          org: document.getElementById('org').value.trim(),
          useCase: document.getElementById('usecase').value.trim(),
          notes: document.getElementById('notes').value.trim()
        },
        selections,
        totals: { totalGPUs: selections.reduce((s,r)=>s+r.qty,0) }
      };

      submitBtn.disabled = true; const original = submitBtn.textContent; submitBtn.textContent = 'Submitting…';
      try {
        let ok = false;
        if (!FLOW_URL || !/^https:\\/\\/.+\\/exec$/.test(FLOW_URL)) {
          showMsg('error','Configure FLOW_URL with your public /macros/s/.../exec URL.'); 
        } else {
          ok = await postJSON(FLOW_URL, payload);
          if (!ok) ok = await beaconGET(FLOW_URL, payload); // fallback always “writes”
        }
        if (ok) showMsg('success','Thanks! Your response was recorded.');
        else showMsg('error','Submission failed. Check your Web App permissions.');
      } catch (e) {
        showMsg('error','Network blocked. Try Incognito or another network.');
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = original;
      }
    });
  </script>
</body>
</html>

